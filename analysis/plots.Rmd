---
title: "Plots"
author: "Dominique Paul"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)

suppressMessages({
  library(ggplotify)
  library(plyr)
  library(dplyr)
  library(scater)
  library(viridis)
  library(ggpubr)
  library(magrittr)
  library(pheatmap)
  library(hrbrthemes)
  library(kableExtra)
  library(tidyr)
  library(tidySingleCellExperiment)
  })

# load utils functions
source("../code/general_purpose_code.R")

# Where to save plots
folder_path <- "../output/plots_paper_jpg/"

# Fixes an issue where a warning message is shown repeatedly
suppressWarnings(suppressMessages(hrbrthemes::import_roboto_condensed()))
```

# Load data

```{r}
sce_integrated <- readRDS(file="../data/EOS_Files/EDI_EOS8_sce.rds")
sce_fresh <- readRDS(file="../data/EOS_Files/Fresh_EOS3_sce.rds")
sce_fvc <- readRDS(file="../data/EOS_Files/FvC_EOS3_sce.rds")

# Load unfiltered data
sce_edi_unfiltered <- readRDS("../data/EOS_Files/EDI_EOS1_sce_unfiltered.rds")
sce_fvc_unfiltered <- readRDS("../data/EOS_Files/FvC_EOS1_sce_unfiltered.rds")

# Change factors for order in plots
sce_fvc$Protocol <- factor(sce_fvc$Protocol, levels=c("Fresh", "Culture"))
sce_fvc$Sample <- factor(sce_fvc$Sample, levels=c("Fresh_S1", "Fresh_S2", "Culture_S1", "Culture_S2", "Culture_S4", "Culture_S5"))
sce_fvc_unfiltered$Protocol <- factor(sce_fvc_unfiltered$Protocol, levels=c("Fresh", "Culture"))
sce_fvc_unfiltered$Sample <- factor(sce_fvc_unfiltered$Sample, levels=c("Fresh_S1", "Fresh_S2", "Culture_S1", "Culture_S2", "Culture_S4", "Culture_S5"))
```


# Annotate subclusters for fresh samples

We load the labels from a mapping stored as excel and add a column with names of the subclusters.

```{r subcluster labels}
subclustering_labels <- read.xlsx("../metadata/marker_genes_heatmaps.xlsx", sheet="Fresh only - subclusters")
# Create a column that corresponds to the current "subcluster_id_long" column 
# in sce_fresh to make mapping easier
subclustering_labels$mapping_key <- paste0(subclustering_labels$Cell.type, "_", subclustering_labels$Cluster)
subclustering_labels$Label <- paste0(subclustering_labels$Order, "-", subclustering_labels$Label)

# Some labels are replicated as we also have marker genes in the table.power
# We want a single one to one mapping so we filter for the cell types and 
# deduplicate the table
subclustering_labels <- subclustering_labels %>%
  mutate(mapping_key = paste0(subclustering_labels$Cell.type, "_", subclustering_labels$Cluster)) %>%
  select(c(mapping_key, Label)) %>%
  ungroup() %>%
  unique()

# We will assign NA values to unmapped subclusters
all_keys_in_sce <- levels(sce_fresh$subcluster_id_long)
unmapped_subclusters <- all_keys_in_sce[all_keys_in_sce %in% subclustering_labels$mapping_key == FALSE]
subclustering_labels <- rbind(subclustering_labels,
                              data.frame(mapping_key = unmapped_subclusters, Label=NA))

# Replace values in the SCE
sce_fresh$subcluster_names <- mapvalues(sce_fresh$subcluster_id_long, subclustering_labels$mapping_key, subclustering_labels$Label)
# Factor values 
sce_fresh$subcluster_names <- factor(sce_fresh$subcluster_names, levels=sort(unique(subclustering_labels$Label)))
```

# Helper functions

```{r helper functions}
normalise_by_row <- function(sce_){
  t(apply(sce_, 1, function(x)((x-min(x))/(max(x)-min(x)))))
}

plot_aggregated_expr <- function(sce, genes, group_var, title, short = FALSE, normalise=TRUE){
  if( short ){
    rownames(sce) <- gsub("^.*\\.","",rownames(sce))
  }
  logNormExpres <- as.data.frame(as.matrix(t(logcounts(sce)[genes,]))) %>% 
    dplyr::mutate(cluster= colData(sce)[,group_var]) %>%
    group_by(cluster) %>% 
    summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% 
    set_rownames(logNormExpres$cluster) %>% 
    dplyr::select(-cluster) %>% 
    as.matrix() %>% 
    t()
  if (normalise) logNormExpresMa <- normalise_by_row(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*\\.","",rownames(logNormExpresMa))
  # If no column names are set
  if (is.null(colnames(logNormExpresMa))) colnames(logNormExpresMa) <- 1:dim(logNormExpresMa)[2]
  return(pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, 
           cluster_cols = F, cluster_rows = F, 
           color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50), 
           main=title, cellwidth=25, cellheight=20,
           display_numbers = round(logNormExpresMa,2), silent=TRUE
           ))
}

# gets centroids of clusters for labelling
get_celltype_centers <- function(sce, dimred, column, offset=c(0,0)){
  cbind(reducedDim(sce, dimred), sce[[column]]) %>%
    as.data.frame() %>%
    dplyr::group_by(V3) %>%
    dplyr::summarise(V1=mean(as.numeric(V1)),
                     V2=mean(as.numeric(V2))) %>%
    mutate(V1 =V1+offset[1], V2 =V2+offset[2])
  }
```

Save some code by defining these

```{r}
no_background_theme <- theme(panel.background=element_blank(),
                              panel.border=element_blank(),
                              panel.grid.major=element_blank(),
                              panel.grid.minor=element_blank(),
                              plot.background=element_blank())

no_ticks_theme <- theme(axis.line=element_blank(),
                      axis.text.x=element_blank(),
                      axis.text.y=element_blank(),
                      axis.ticks=element_blank(),
                      axis.title.x=element_blank(),
                      axis.title.y=element_blank())
```

Update the theme we will use

```{r}
theme_ipsum_updated <- theme_ipsum_rc(base_size = 15, plot_margin = margin(30, 30, 30, 50),  axis_title_size = 12)
```


# Add extra columns for plots

In previous versions of UMAPs the cells are sometimes covered by their labels. We reduce these to (1) just numbers on the plot (2) "[number]-[annotation]" in the legend. For this we add two additional columns for thes


```{r numbered labels}
# Major labels for fresh cells
lvls_labels_fresh <- levels(sce_fresh$manual_labels_coarse)
number_labels_fresh <- 1:length(lvls_labels_fresh)
sce_fresh$manual_labels_numeric <- mapvalues(sce_fresh$manual_labels_coarse, from=lvls_labels_fresh, to=number_labels_fresh)

# Major labels for the integrated data
lvls_labels_fvc <- levels(sce_fvc$manual_labels_coarse)
number_labels_fvc <- 1:length(lvls_labels_fvc)
sce_fvc$manual_labels_numeric <- mapvalues(sce_fvc$manual_labels_coarse, from=lvls_labels_fvc, to=number_labels_fvc)

# Major labels for the integrated data
lvls_labels_integ <- levels(sce_integrated$manual_labels_coarse)
number_labels_integ <- 1:length(lvls_labels_integ)
sce_integrated$manual_labels_numeric <- mapvalues(sce_integrated$manual_labels_coarse, from=lvls_labels_integ, to=number_labels_integ)

```

# Figure 2 (Fresh only)

* A: UMAP (Fresh only)
* B: Heatmap (Fresh only)
* C: Barplots cell type (Fresh only)
* D: Subclustering Macrophages 

```{r}
#########
### A ###
#########

celltype_centers <- get_celltype_centers(sce_fresh, "UMAP", "manual_labels_numeric", offset=c(0,2))

Fig2a <- plotReducedDim(sce_fresh, "UMAP", colour_by="manual_labels_coarse", point_size=0.25, text_size=7) +
  theme_ipsum_updated +
  get_cell_colours(levels(sce_fresh$manual_labels_coarse), number_labels=T) +
  theme(legend.position="bottom",
        panel.spacing = unit(10, "mm")) +
  geom_label(aes(V1, V2, label=V3), data=celltype_centers) +
  guides(color=guide_legend(title="",
                            nrow=2,
                            byrow=TRUE, 
                            override.aes = list(size=5, shape = 15, alpha = 1)))

#########
### B ###
#########

genes <- c("DCN", "COL1A1", "COL6A1", "TAGLN", "ACTA2", "RGS5", "PECAM1", 
           "VWF", "CLDN5", "FABP4", "LYVE1", "CCL21", "KRT5", "KRT10", "KRT15", 
           "IL7R", "CD3D", "CXCR4", "LYZ", "HLA-DRA", "CXCL8", "TPSB2", "TPSAB1", 
           "CTSG", "PMEL", "DCT", "MLANA", "CDH19", "CRYAB", "ITGB8")

cell_type_order <- c("Fibroblasts", "Pericytes/VSMC",	"Vascular endothelial",	"Lymphatic endothelial", "Keratinocytes",	"T cells",	"Macrophages/DC",	"Mast cells", "Melanocytes", "Schwann cells")

# sample at most 100 cells per celltype
set.seed(100)
selected_cells <- sapply(levels(sce_fresh$manual_labels_coarse), function(ctype){
  cnames <- colnames(sce_fresh[,sce_fresh$manual_labels_coarse == ctype])
  if (length(cnames) > 100) cnames <- cnames[sort(sample(1:length(cnames), 100))]
  cnames
}) %>% purrr::reduce(c)

sce_fresh_plot <- sce_fresh[,selected_cells]

# the cells which we want to display, ordered by cell type
column_annotations <- data.frame(cell_name=rownames(colData(sce_fresh_plot)),
                                 Sample=sce_fresh_plot$Sample,
                                Cell_type=factor(colData(sce_fresh_plot)[,"manual_labels_coarse"], levels=cell_type_order)) %>%
    filter(Cell_type!="NA") %>%
    arrange(Cell_type) %>%
    tibble::column_to_rownames(var="cell_name")

# the logcounts which we need for the pheatmap function
sce_plot <- logcounts(sce_fresh_plot[genes, rownames(column_annotations)])
sce_plot <- normalise_by_row(sce_plot)

# Use own colours for the column annotations
colours <- get_cell_colours(cell_type_order, type="raw", sort=F)
colours_sample <- get_sample_colours(levels(sce_fresh_plot$Sample), type="raw")
annotation_colours <- list("Sample"=colours_sample, "Cell_type"=colours)


# create the plot. We convert to ggplot to take advantage of some of the display functions
Fig2b <- as.ggplot(pheatmap(sce_plot, annotation_col=column_annotations, annotation_colors=annotation_colours,
         show_rownames=TRUE, show_colnames=FALSE, cluster_cols=FALSE, cluster_rows = FALSE, silent=TRUE,
         color=viridis(50))) +
  theme_ipsum_updated +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(), 
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank())
Fig2b


#########
### C ###
#########

sce_fresh$manual_labels_coarse <- factor(sce_fresh$manual_labels_coarse, levels=cell_type_order)

Fig2c <- as.data.frame(colData(sce_fresh)) %>%
  dplyr::group_by(manual_labels_coarse) %>%
  dplyr::summarise(counts=n()) %>%
  ggplot(aes(x=manual_labels_coarse, y=counts, fill=manual_labels_coarse)) +
   geom_bar(colour="black", stat="identity") +
   theme_ipsum_updated +
   labs(x="", y="Number of cells") +
   theme(axis.text.x=element_text(angle=50, hjust=1)) +
  guides(fill="none") +
  get_cell_colours(levels(sce_fresh$manual_labels_coarse), type="fill")
Fig2c

#########
### D ###
#########
get_annotated_subcluster <- function(cell_type){
  sce_subset <- sce_fresh[,sce_fresh$manual_labels_coarse2 == cell_type]
  
  celltype_centers <- get_celltype_centers(sce_subset, paste0("UMAP_", cell_type), "subcluster_id")
  
  plt <- plotReducedDim(sce_subset, paste0("UMAP_", cell_type),
                 colour_by = "subcluster_names") +
    theme_ipsum_updated +
    labs(x="UMAP 1", y="UMAP 2") +
    get_unnamed_colours(unique(sce_subset$subcluster_names), "Subcluster", type="colour") +
    theme(legend.position="bottom",
          panel.spacing = unit(10, "mm")) +
    guides(color=guide_legend(title="",
                              nrow=ceiling(length(unique(sce_subset$subcluster_names)) / 3),
                              override.aes=list(size=5, shape=15, alpha=1))) +
    labs(title=cell_type) +
    geom_label(aes(V1, V2, label=V3), data=celltype_centers)
  plt
}

Fig2d <- get_annotated_subcluster("Macrophages/DC")
Fig2d
```

## Output

```{r, fig.width=20, fig.height=26}
# figure2 <- ggarrange(
#   Fig2a,
#   ggarrange(Fig2b, 
#             ggarrange(Fig2c, Fig2d, ncol = 1, 
#                       labels = c("C", "D"), font.label = list(size = 30)),
#             ncol = 2, widths=c(1.4,1)),
#   ncol = 1, nrow = 2,labels = c("A", "B"), font.label = list(size = 30)
# )

figure2 <- ggarrange(
  Fig2a,
  Fig2b,
  ggarrange(Fig2c, Fig2d, ncol = 2, labels = c("C", "D"), font.label = list(size = 30)),
  ncol = 1, nrow = 3,labels = c("A", "B", ""), heights=c(1.5,1,1), font.label = list(size = 30)
)



suppressWarnings(figure2)

scale <- 0.8
ggsave(paste0(folder_path, "figure2.jpg"),
       plot=figure2,
       width=20*scale,
       height=26*scale,
       units="in",
       bg="white")
```


# Figure 3: Fresh only

* A: Subclustering Fibroblasts
* B: Violin plot fibroblasts
* C: Subclustering Keratinocytes
* D: Subclustering Pericytes

```{r Figure 3}
# A: Fibroblasts
Fig3a <- get_annotated_subcluster("Fibroblasts") 

#########
### B ###
#########
papillary_genes <- c("COL18A1", "APCDD1", "HSPB3", "NPTX2", "ROBO2", "COL23A1", "PTGDS", "PDPN", "COL7A1", "COLEC12", "AXIN2")
reticular_genes <- c("MFAP5", "MGP", "FGF7", "A2M", "ANGPTL1", "IGF1", "EFEMP1", "PCSK5", "MAP1B", "COMP")

# subset to a sce object with only the fibroblasts as annotated manually
fibro_sce <- sce_fresh[,colData(sce_fresh)$manual_labels_coarse == "Fibroblasts"]

genes <- c(papillary_genes, reticular_genes)
gene_counts <- logcounts(fibro_sce)[genes,]
gene_counts <- normalise_by_row(gene_counts)

res <- lapply(unique(fibro_sce$subcluster_id), function(fibro_type){
  mask <- fibro_sce$subcluster_id == fibro_type
  data.frame("genes"=genes, "rowmeans"=rowMeans(gene_counts[, mask]), "subcluster"=fibro_type)
}) %>% purrr::reduce(rbind)

sfig6a <- ggplot(res[res$genes %in% papillary_genes, ], aes(x=genes, y=rowmeans, fill=subcluster)) +
  geom_bar(stat="identity", position="dodge") +
  theme(axis.text.x = element_text(angle = 45,hjust=1), axis.ticks.x=element_blank()) +
  labs(title="Marker genes for papillary fibroblasts",
       x="", y="") +
  theme_ipsum_updated

sfig6b <- ggplot(res[res$genes %in% reticular_genes, ], aes(x=genes, y=rowmeans, fill=subcluster)) +
  geom_bar(stat="identity", position="dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust=1), axis.ticks.x=element_blank()) +
  labs(title="Marker genes for reticular fibroblasts",
       x="", y="") +
  theme_ipsum_updated


# average of logcounts for papillary fibroblast genes
fibro_sce$papillary_gene_avg <- colMeans(logcounts(fibro_sce)[papillary_genes,])
# average of logcounts for reticular fibroblast genes
fibro_sce$reticular_gene_avg <- colMeans(logcounts(fibro_sce)[reticular_genes,])

violin_plot1 <- plotColData(fibro_sce, x="subcluster_id", y="papillary_gene_avg", colour_by="subcluster_id") +
  labs(title="Papillary Fibroblasts",
       # subtitle="Average gene expression for a selection of genes",
       x="", y="") +
  ylim(0,2.5) +
  theme_ipsum_updated +
  get_unnamed_colours(unique(fibro_sce$subcluster_id), "", type="colour") +
  theme(legend.position="none",
        plot.margin=margin(t=5,l=30,r=30, b=5))


violin_plot2 <- plotColData(fibro_sce, x="subcluster_id", y="reticular_gene_avg", colour_by="subcluster_id") +
  labs(title="Reticular Fibroblasts",
       # subtitle="Average gene expression for a selection of genes", 
       y="", x="") +
  ylim(0,2.5) +
  theme_ipsum_updated +
  get_unnamed_colours(unique(fibro_sce$subcluster_id), "", type="colour") +
  theme(legend.position="none",
        plot.margin=margin(t=5,l=30,r=30, b=5))

Fig3b <- ggarrange(violin_plot1, violin_plot2, nrow=2)

# C: Keratinocytes
Fig3c <- get_annotated_subcluster("Keratinocytes")

# D: Keratinocytes
Fig3d <- get_annotated_subcluster("Pericytes/VSMC")
```

## Output

```{r, fig.width=20, fig.height=20}
figure3 <- ggarrange(
  Fig3a,
  Fig3b,
  Fig3c,
  Fig3d,
  ncol = 2, nrow = 2,labels = "AUTO", font.label = list(size = 30)
)

# suppressWarnings(figure3)

scale <- 0.8
ggsave(paste0(folder_path, "figure3.jpg"),
       plot=figure3,
       width=20*scale,
       height=26*scale, 
       units="in",
       bg="white")
```

# Suppl. Figure 5

## Panel C

```{r}
sce_fresh_fibroblasts <- sce_fresh[,sce_fresh$manual_labels_coarse == "Fibroblasts"]

genes <- c(papillary_genes, reticular_genes)

fibro_subcluster_order <- c("3-FOS/JUNhigh papillary", 
                            "4-Anti-oxidative papillary HMOX1+",
                            "5-Papillary PLCG2+",
                            "1-Secretory reticular MFAP5+",
                            "2-Proinflammatory reticular CCL19+")

# the cells which we want to display, ordered by cell type
column_annotations <- data.frame(cell_name=rownames(colData(sce_fresh_fibroblasts)), 
                                Cell_type=factor(sce_fresh_fibroblasts$subcluster_names, levels=fibro_subcluster_order)) %>%
    filter(Cell_type!="NA") %>%
    arrange(Cell_type) %>%
    tibble::column_to_rownames(var="cell_name") %>%
  mutate(Type=ifelse(Cell_type %in% c("1-Secretory reticular MFAP5+", "2-Proinflammatory reticular CCL19+"), "Reticular", "Papillary"))

# the logcounts which we need for the pheatmap function
sce_plot <- logcounts(sce_fresh_fibroblasts[genes, rownames(column_annotations)])
sce_plot <- normalise_by_row(sce_plot)

# Use own colours for the column annotations
colours <- get_unnamed_colours(fibro_subcluster_order, type="raw")
annotation_colours <- list("Cell_type"=colours)


# create the plot. We convert to ggplot to take advantage of some of the display functions
sfig6c <- as.ggplot(pheatmap(sce_plot, annotation_col=column_annotations, annotation_colors=annotation_colours,
         show_rownames=TRUE, show_colnames=FALSE, cluster_cols=FALSE, cluster_rows = FALSE, silent=TRUE,
         color=viridis(50))) +
  theme_ipsum_updated +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(), 
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank())
  # labs(title="Selected marker genes for cell types")
sfig6c
```

```{r, fig.width=20, fig.height=24}
sfig5 <- ggarrange(sfig6a, sfig6b, sfig6c, ncol=1, heights=c(1,1,2), labels="AUTO", font.label = list(size = 30))

suppressWarnings(sfig5)

scale <- 0.7
ggsave(paste0(folder_path, "Suppl_figure5.jpg"),
       plot=sfig5,
       width=20*scale,
       height=26*scale,
       units="in",
       bg="white")
```

# Figure 4 (FvC)

* A: UMAP by cell type (FvC)
* B: UMAP by protocol (FvC)
* C: Heatmap of currently "special" dot plot (FvC)
* D: Heatmap of Fibroblasts only with the genes: COL1A1, COL1A2, DCN, COL6A1, COL6A2,MMP1, MMP3, IGFBP3, CXCL3, IL6, TNFAIP6, CXCL2 (FvC)

## A and B 

```{r Figure 4, fig.width=14, fig.height=8}
 # A
celltype_centers <- get_celltype_centers(sce_fvc, "UMAP", "manual_labels_numeric", offset=c(-.5,-1))

Fig4a <- plotReducedDim(sce_fvc, "UMAP", colour_by="manual_labels_coarse", point_size=0.25) +
  # labs(title="UMAP coloured by cell type",
  #      subtitle = "Fresh and cultured samples") +
  theme_ipsum_updated +
  get_cell_colours(levels(sce_fvc$manual_labels_coarse), number_labels=T) +
  theme(legend.position="right",
        panel.spacing = unit(5, "mm"),
        plot.margin=margin(t=5, l=50, r=100, b=5)) +
  guides(color=guide_legend(title="",
                            # nrow=3,
                            byrow=TRUE, 
                            override.aes = list(size=4, shape = 15, alpha = 1))) +
  geom_label(aes(V1, V2, label=V3), data=celltype_centers)

Fig4a

# B
Fig4b <- plotReducedDim(sce_fvc, "UMAP", colour_by="Sample", point_size=0.25) +
  # labs(title="UMAP coloured by protocol",
  #      subtitle = "Fresh and cultured samples") +
  theme_ipsum_updated +
  # get_protocol_colours(levels(sce_fvc$Protocol)) +
  theme(legend.position="right",
        panel.spacing = unit(5, "mm"),
        plot.margin=margin(t=5, l=50, r=100, b=5)) +
  guides(color=guide_legend(title="",
                            # nrow=1,
                            byrow=TRUE, 
                            override.aes = list(size=4, shape = 15, alpha = 1)))
Fig4b
```

## Figure 4c

```{r, fig.width=14, fig.height=5}
# Read in a list with marker genes
marker_overview <- read.xlsx(xlsxFile="../Metadata/Special_plot_markers.xlsx")

genes_df <- marker_overview %>%
  dplyr::rename(cell_type=Cell.type, gene=Marker)

# Check if any genes were not found in data
genes_not_found <- genes_df$gene[!genes_df$gene %in% rownames(sce_fvc)]
if (length(genes_not_found) != 0L) cat(paste0("Genes not found in data: ", genes_not_found))
genes_df <- genes_df[genes_df$gene %in% rownames(sce_fvc),]

# order of cell types
cell_type_order <- c("Fibroblasts", "Pericytes/VSMC",	"Vascular endothelial",	
                     "Lymphatic endothelial", "Keratinocytes",	"T cells",	
                     "Macrophages",	"Dendritic cells", "Mast cells", "Melanocytes", 
                     "Schwann cells", "Sweat gland cells")
genes_df$cell_type <- factor(genes_df$cell_type, levels=cell_type_order)

# normalisation function
normalit <- function(m) (m - min(m))/(max(m)-min(m))

# for cell.types in cell.types get mean expression of genes by sample
# considering only the cells in the specific cell types
heatmap_values <- lapply(unique(genes_df$cell_type), function(cell_type){
  sce_subset <- sce_fvc[,sce_fvc$manual_labels_coarse == cell_type]
  genes <- genes_df[genes_df$cell_type == cell_type, "gene"]
  # log_counts <- normalise_by_row(logcounts(sce_fvc)[genes,])
  log_counts <- logcounts(sce_subset)[genes,]
  
  logNormExpres <- as.data.frame(as.matrix(t(log_counts))) %>% 
    dplyr::mutate(Protocol=colData(sce_subset)[,"Protocol"], Sample=colData(sce_subset)[,"Sample"]) %>%
    group_by(Protocol, Sample) %>% 
    summarise_all(mean) %>%
    ungroup() %>%
    # normalise by gene
    mutate_each_(normalit, vars=3:dim(.)[2]) %>%
    # Transform into log
    tidyr::gather(key="Gene", "Value", -c(Protocol, Sample)) %>%
    mutate("Cell.type"=cell_type)
  
  logNormExpres
}) %>% purrr::reduce(rbind)

# Shorten some names
replacements <- list(c("Vascular endothelial", "Vasc. Endo."),
                  c("Lymphatic endothelial", "Lym. Endo."),
                  c("Sweat gland cells", "Sweat gl."),
                  c("Dendritic cells", "Dendritic"),
                  c("Schwann cells", "Schwann"),
                  c("Macrophages", "Macroph."),
                  c("Melanocytes", "Melano."))
for (idx in 1:length(replacements)){
  old <- replacements[[idx]][1]
  new <- replacements[[idx]][2]
  heatmap_values$Cell.type <- sub(old, new, heatmap_values$Cell.type)
  cell_type_order <- sub(old, new, cell_type_order)
}

heatmap_values$Cell.type <- factor(heatmap_values$Cell.type, levels=cell_type_order)

# plot
Fig4c <- ggplot(heatmap_values, aes(x=Gene, y=Sample, fill=Value), otherInfo( Protocol)) +
  geom_tile() +
  facet_grid(Protocol~Cell.type, scales="free", space="free") +
  theme_ipsum_updated +
  theme(axis.text.x = element_text(angle = 90, hjust=1), 
        axis.ticks.x=element_blank(),
        panel.spacing = unit(3, "mm"),
        strip.text.y = element_blank(),
        strip.text.x = element_text(size=11),
        plot.margin = margin(t=5, b=5, r=30, l=50)
        ) +
  labs(#title="Comparison of selected genes for each cell type",
       #subtitle="Normalised by column",
       y="", x="") +
  scale_fill_viridis() +
  guides(fill="none") +
  no_background_theme
  #no_ticks_theme
Fig4c
```


### Figure 4c alternative v1

```{r figure 4c alternative v1, fig.width=14, fig.height=4}
# for cell type in cell_types
# get logcounts
# add sample and protocol as columns
# convert to long
# 
# all_samples <- levels(sce_subset$Sample)
# 
# averaged_values <- lapply(cell_type_order, function(cell_type){
#   print(cell_type)
#     
#   genes <- genes_df[genes_df$cell_type == cell_type, "gene"]
#   
#   sce_subset <- sce_fvc[,sce_fvc$manual_labels_coarse == cell_type]
#   
#   # Make sure we have at least 100 cells from each sample
#   n_cells <- min(100, table(sce_subset$Sample))
#   
#   # Get a random sample of the given cell type from each sample
#   #set.seed(100)
#   cell_names <- lapply(all_samples, function(sample){
#     all_cell_names <- colnames(sce_subset[,sce_subset$Sample == sample])
#     sample(all_cell_names, n_cells)
#   }) %>% purrr::reduce(c)
#   
#   # subset for these cells
#   sce_subset <- sce_subset[,cell_names]
#   
#   # get average values for the given genes
#   log_counts <- t(normalise_by_row(logcounts(sce_subset)[genes,])) %>%
#     as.data.frame() %>%
#     mutate(Sample=sce_subset$Sample, 
#            Protocol=sce_subset$Protocol, 
#            "cell_type"=cell_type,
#            index=rep(1:n_cells, times=length(all_samples))) %>%
#     pivot_longer(cols=1:5)
# }) %>% purrr::reduce(rbind)
# 
#   
# ggplot(log_counts, aes(x=index, y=Sample, fill=value), otherInfo(Protocol, name)) +
#   geom_tile() +
#   facet_grid(Protocol~name, scales="free", space="free") +
#   theme_ipsum_updated +
#   theme(axis.text.x = element_text(angle = 90, hjust=1), 
#         axis.ticks.x=element_blank(),
#         panel.spacing = unit(3, "mm"),
#         #strip.text.y = element_blank(),
#         #strip.text.x = element_blank(), #element_text(size=11),
#         plot.margin = margin(t=5, b=5, r=30, l=30)
#         ) +
#   labs(title="Comparison of selected genes for each cell type",
#        subtitle="Normalised by column",
#        y="", x="") +
#   scale_fill_viridis() +
#   guides(fill="none") +
#   no_background_theme +
#   no_ticks_theme

```



### Figure 4c alternative v2

```{r figure 4c alternative v2, fig.width=14, fig.height=4}
heatmap_values <- lapply(unique(genes_df$cell_type), function(cell_type){
  sce_subset <- sce_fvc[,sce_fvc$manual_labels_coarse == cell_type]
  genes <- genes_df[genes_df$cell_type == cell_type, "gene"]
  # log_counts <- normalise_by_row(logcounts(sce_fvc)[genes,])
  log_counts <- logcounts(sce_subset)[genes,]
  
  logNormExpres <- as.data.frame(as.matrix(t(log_counts))) %>% 
    dplyr::mutate(Protocol=colData(sce_subset)[,"Protocol"]) %>%
    group_by(Protocol) %>% 
    summarise_all(mean) %>%
    ungroup() %>%
    # normalise by gene
    # mutate_each_(normalit, vars=2:dim(.)[2]) %>%
    # Transform into log
    tidyr::gather(key="Gene", "Value", -c(Protocol)) %>%
    mutate("Cell.type"=cell_type)
  
  logNormExpres
}) %>% purrr::reduce(rbind)

# Shorten some names
replacements <- list(c("Vascular endothelial", "Vasc. Endo."),
                  c("Lymphatic endothelial", "Lym. Endo."),
                  c("Sweat gland cells", "Sweat gl."),
                  c("Dendritic cells", "Dendritic"),
                  c("Schwann cells", "Schwann"),
                  c("Macrophages", "Macroph."),
                  c("Melanocytes", "Melano."))
for (idx in 1:length(replacements)){
  old <- replacements[[idx]][1]
  new <- replacements[[idx]][2]
  heatmap_values$Cell.type <- sub(old, new, heatmap_values$Cell.type) 
}

# factorise
heatmap_values$Cell.type <- factor(heatmap_values$Cell.type, levels=unique(heatmap_values$Cell.type))

# plot
Fig4c_v2 <- ggplot(heatmap_values, aes(x=Gene, y=Protocol, fill=Value, colour=Value), otherInfo( Protocol)) +
  geom_point(size=5) +
  facet_grid(Protocol~Cell.type, scales="free", space="free") +
  theme_ipsum_updated +
  theme(axis.text.x = element_text(angle = 90, hjust=1), 
        axis.ticks.x=element_blank(),
        panel.spacing = unit(3, "mm"),
        strip.text.y = element_blank(),
        strip.text.x = element_text(size=11),
        plot.margin = margin(t=5, b=5, r=30, l=50)
        ) +
  labs(#title="Comparison of selected genes",
       #subtitle="Normalised by column",
       y="", x="") +
  scale_fill_viridis() +
  scale_colour_viridis() +
  guides(fill="none") + 
  guides(colour="none") +
  no_background_theme
Fig4c_v2
```

## Figure 4d

```{r fvc special heatmap}
genes <- c("COL1A1", "COL1A2", "DCN", "COL6A1", "COL6A2", "MMP1", "MMP3", "IGFBP3", "CXCL3", "IL6", "TNFAIP6", "CXCL2")

sce_fvc_fibroblasts <- sce_fvc[,sce_fvc$manual_labels_coarse == "Fibroblasts"]
# sample to make plot fit
# set.seed(100)
# sce_fvc_fibroblasts[,sample(colnames(sce_fvc_fibroblasts), 1000)]

# the cells which we want to display, ordered by cell type
column_annotations <- data.frame("cell_name"=rownames(colData(sce_fvc_fibroblasts)),
                                 "Sample"=factor(colData(sce_fvc_fibroblasts)[,"Sample"]),
                                 "Protocol"=factor(sce_fvc_fibroblasts$Protocol)) %>%
    tibble::column_to_rownames(var="cell_name")

# the logcounts which we need for the pheatmap function
sce_plot <- logcounts(sce_fvc_fibroblasts[genes, rownames(column_annotations)])
sce_plot <- normalise_by_row(sce_plot)

# Use own colours for the column annotations
colours_protocol <- get_protocol_colours(unique(sce_fvc_fibroblasts$Protocol), type="raw")
colours_sample <- get_sample_colours(unique(sce_fvc_fibroblasts$Sample), type="raw")
annotation_colours <- list("Sample"=colours_sample, "Protocol"=colours_protocol)


# create the plot. We convert to ggplot to take advantage of some of the display functions
Fig4d <- as.ggplot(pheatmap(sce_plot, annotation_col=column_annotations, annotation_colors=annotation_colours,
         show_rownames=TRUE, show_colnames=FALSE, cluster_cols=FALSE, cluster_rows = FALSE, silent=TRUE,
         color=viridis(50))) +
  theme_ipsum_updated +
  no_background_theme +
  no_ticks_theme
  # labs(title="Selected genes for Fibroblasts")
Fig4d
```

## Output

```{r figure4 one figure, fig.width=20, fig.height=26}
figure4 <- ggarrange(
  Fig4a,
  Fig4b,
  Fig4c,
  Fig4d,
  ncol = 1,labels = c("AUTO"), font.label = list(size = 30),
  heights = c(1,1,0.8,0.8)
)

# suppressWarnings(figure4)

scale <- 0.7
ggsave(paste0(folder_path, "figure4.jpg"),
       plot=figure4,
       width=20*scale,
       height=26*scale,
       units="in",
       bg="white")
# 
# figure4_v2 <- ggarrange(
#   Fig4a,
#   Fig4b,
#   Fig4c_v2,
#   Fig4d,
#   ncol = 1,labels = c("AUTO"), font.label = list(size = 30),
#   heights = c(1,1,0.6,0.8)
# )
# 
# # suppressWarnings(figure4)
# 
# scale <- 0.7
# ggsave(paste0(folder_path, "figure4_v2.jpg"),
#        plot=figure4_v2,
#        width=20*scale,
#        height=26*scale,
#        units="in",
#        bg="white")
```

# Figure 5: 

## Panel A

```{r}
# A1
fig5a1 <- colData(sce_edi_unfiltered) %>% 
  as.data.frame() %>%
  ggplot(aes(x=log_total, y=subsets_genes_detected, color=to_be_dropped)) +
  geom_point(size=0.25) +
  labs(y="",
       x="Library size (log10)",
       #title="Library size vs. number of non-mitochondrial genes",
       #subtitle="Cells dropped coloured in red"
       ) +
  scale_y_log10() +
  geom_density_2d() +
  facet_wrap(~Sample, nrow=4) +
  theme_ipsum_updated +
  theme(panel.spacing = unit(2, "mm"),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        strip.text.x = element_text(size = 10),
        plot.margin = margin(t = 2,
                             r = 20,
                             l = 20,
                             b = 2)) +
  guides(color=guide_legend(title="Dropped")) +
  scale_colour_manual(values=c("#DB1E0D", "#2065AE"))

# A2
fig5a2 <- ggplot(colData(sce_edi_unfiltered) %>% as.data.frame,
       aes(x=log_total, y=subsets_genes_detected, color=subsets_Mt_percent)) +
  geom_point(size=0.25) +
  labs(#title="Library size vs. number of non-mitochondrial genes",
       #subtitle="Colour indicates mito. percentage of library size",
       x="Library size (log10)",
       y="") +
  scale_y_log10() +
  geom_density_2d() + 
  facet_wrap(~Sample, nrow=4) +
  theme_ipsum_updated +
  theme(panel.spacing = unit(2, "mm"),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        strip.text.x = element_text(size = 10),
        plot.margin = margin(t = 2,
                             r = 20,
                             l = 20,
                             b = 2)) +# Left margin) +
  guides(color=guide_colourbar(title="% mito.")) 
```

## Panel B

```{r}
sample_to_protocol <- colData(sce_integrated) %>%
  as.data.frame() %>%
  dplyr::group_by(Protocol, Sample) %>%
  dplyr::summarise()

cc_sample <- sce_integrated %>% 
  nest(data=-Sample) %>% 
  mutate(n_cells = purrr::map_dbl(data, ~ dim(.x)[2]),
         sum_of_genes = purrr::map_dbl(data, ~ sum(colData(.x)$detected)),
         average_n_genes = purrr::map_dbl(data, ~ mean(colData(.x)$detected)),
         mean_n_nonzero_genes = purrr::map_dbl(data, ~ mean(rowSums(counts(.x) > 0) > 0)),
         mean_n_10cells_genes = purrr::map_dbl(data, ~ mean(rowSums(counts(.x) > 0) > 10)),
         mean_n_1perc_cells_genes = purrr::map_dbl(data, ~ mean(rowSums(counts(.x) > 0) > ceiling(dim(.x)[2]/100)))) %>%
  left_join(sample_to_protocol, by="Sample")


fig5b <- ggpubr::ggarrange(
  ggplot(cc_sample, aes(x = Sample, y = n_cells, fill = average_n_genes)) +  # Plot with values on top
    geom_bar(stat = "identity") +
    geom_text(aes(label = n_cells), vjust = 0, size = 3) +
    facet_grid(. ~ Protocol, scales="free_x", space="free_x") +
    labs(title = "", x="", fill="Mean genes\nper cell", y="Cells") +
    theme_ipsum_updated +
    theme(axis.text.x = element_text(angle = 45, hjust=1, size=8), 
          axis.text.y = element_text(size=8),
          axis.ticks.x = element_blank(),
          strip.text.x = element_blank(),
          panel.spacing = unit(2, "mm"),
          plot.margin = margin(2,2,2,2)),
  
  ggplot(cc_sample, aes(x = Sample, y = n_cells, fill = mean_n_1perc_cells_genes)) +  # Plot with values on top
    geom_bar(stat = "identity") +
    geom_text(aes(label = n_cells), vjust = 0, size = 3) +
    facet_grid(. ~ Protocol, scales="free_x", space="free_x") +
    labs(#title = "", 
      x="", fill="Num. genes\nin at least \n1% of cells",  y="Cells") +
    theme_ipsum_updated +
    theme(axis.text.x = element_text(angle = 45,hjust=1, size=8), 
          axis.text.y = element_text(size=8),
          axis.ticks.x=element_blank(),
          strip.text.x = element_blank(),
          panel.spacing = unit(2, "mm"),
          plot.margin = margin(2,2,2,2)),
  nrow = 2)
```

## Panel C

```{r 6 panel c}
fig5c1 <- sce_integrated %>% 
  ggplot() +
  theme_ipsum_updated +
  labs(#title="Distribution of cell library sizes",
       x="Log total expression", y="Density") +
  geom_density(aes(log10(total), fill=Protocol, color=Protocol), alpha=0.3) +
  get_protocol_colours(levels(colData(sce_integrated)$Protocol), type="fill") +
  get_protocol_colours(levels(colData(sce_integrated)$Protocol)) +
  theme(plot.margin = margin(30,20,30,50))

fig5c2 <- sce_integrated %>% 
  ggplot() +
  geom_density(aes(log10(total), fill=Sample, color=Sample),alpha=0.1) +
  facet_grid(Protocol~.) +
  theme_ipsum_updated +
  theme(strip.text.y = element_text(size = 12),
        legend.text=element_text(size=8),
        legend.key.size= unit(5, "mm"),
        plot.margin = margin(30,20,30,30)) +
  guides(fill=guide_legend(ncol=1, )) +
  labs(#title="Distribution of cell library sizes",
       x="Log total expression", y="Density") +
  theme(panel.spacing = unit(2, "mm")) +
  get_sample_colours(levels(colData(sce_integrated)$Sample), type="fill") +
  get_sample_colours(levels(colData(sce_integrated)$Sample))

```

## Panel D

```{r}
fig5d1 <- sce_integrated %>% 
  ggplot() +
  geom_density(aes(log10(detected), fill=Protocol, color=Protocol), alpha=0.3) +
  theme_ipsum_updated +
  labs(#title="Distribution of gene counts",
       x="Number of genes (log10)", y="Density") +
  get_protocol_colours(levels(colData(sce_integrated)$Protocol)) +
  get_protocol_colours(levels(colData(sce_integrated)$Protocol), type="fill") +
  theme(plot.margin = margin(30,20,30,50))

fig5d2 <- sce_integrated %>% 
  ggplot() +
  geom_density(aes(log10(detected), fill=Sample, color=Sample),alpha=0.1) +
  facet_grid(Protocol~.) +
  theme_ipsum_updated +
  theme(strip.text.y = element_text(size = 12),
        legend.text=element_text(size=8),
        legend.key.size= unit(5, "mm"),
        plot.margin = margin(30,20,30,30)) +
  guides(fill=guide_legend(ncol=1)) +
  labs(#title="Distribution of gene counts",
       x="Number of genes (log10)", y="Density") +
  get_sample_colours(levels(colData(sce_integrated)$Sample), type="fill") +
  get_sample_colours(levels(colData(sce_integrated)$Sample))
```

## Output

```{r Figure 5, fig.width=20, fig.height=24}
Fig5 <- ggpubr::ggarrange(
  ggpubr::ggarrange(fig5a1,fig5a2, ncol = 2),
  fig5b,
  ggpubr::ggarrange(fig5c1, fig5c2, ncol=2),
  ggpubr::ggarrange(fig5d1, fig5d2, ncol=2),
  ncol = 1, nrow = 4,labels = "AUTO", font.label = list(size = 30)
)

# suppressWarnings(Fig5)

ggsave(paste0(folder_path, "figure5.jpg"),
       plot=Fig5,
       width=20*0.9,
       height=26*0.9,
       units="in",
       bg="white")
```


# Figure 6

* UMAP by cell type (Integrated data)
* UMAP by protocol (Integrated data)
* Boxplot of all cell types with one scale
* Differential abundance (Integrated data)

```{r figure 6, fig.width=10, fig.height=7}
# A
celltype_centers <- get_celltype_centers(sce_integrated, "UMAP", "manual_labels_numeric", offset=c(-0.6,-0.7))

Fig6a <- plotReducedDim(sce_integrated, "UMAP", colour_by="manual_labels_coarse",point_size=0.25) +
  # labs(title="UMAP coloured by cell type",
  #      subtitle = "Integrated datasets") +
  theme_ipsum_updated +
  get_cell_colours(levels(sce_integrated$manual_labels_coarse), number_labels=T) +
  theme(legend.position="right",
        panel.spacing = unit(5, "mm"),
        plot.margin = margin(30,100,30,150)) +
  guides(color=guide_legend(title="",
                            # nrow=3,
                            byrow=TRUE, 
                            override.aes = list(size=4, shape = 15, alpha = 1))) +
  geom_label(aes(V1, V2, label=V3), data=celltype_centers)
  

# B
Fig6b <- plotReducedDim(sce_integrated, "UMAP", colour_by="Protocol", point_size=0.25) +
  # labs(title="UMAP coloured by protocol",
  #      subtitle = "Integrated datasets") +
  theme_ipsum_updated +
  get_protocol_colours(levels(sce_integrated$Protocol)) +
  theme(legend.position="right",
        panel.spacing = unit(5, "mm"),
        plot.margin = margin(30,100,30,150)) +
  guides(color=guide_legend(title="",
                            # nrow=1,
                            byrow=TRUE, 
                            override.aes = list(size=4, shape = 15, alpha = 1)))

# C
Fig6c <- as.data.frame(colData(sce_integrated)) %>%
  dplyr::group_by(manual_labels_coarse) %>%
  dplyr::summarise(counts=n()) %>%
  mutate(perc=round(counts/sum(counts), 2)) %>%
  mutate(manual_labels_coarse=sub("Melanocytes/Schwann cells/Neuronal cells", "Melanocytes/Schwann/Neuronal", manual_labels_coarse)) %>%
  ggplot(aes(x=1, y=perc, fill=forcats::fct_rev(manual_labels_coarse))) +
  geom_bar(aes(width=0.1), colour="black", stat="identity") +
  theme_ipsum_updated +
  get_cell_colours(levels(sce_integrated$manual_labels_coarse), type="fill") +
  labs(# title="Relative frequencies of cell types",
        # subtitle="Integrated data",
        x="", y="Percentage of cells") +
  theme(axis.text.y=element_blank(),
        legend.position="right",
        plot.margin=margin(50, 100, 30, 100)
        ) +
  guides(fill=guide_legend(title="Cell type",
                           title.position="top",
                           ncol=2,
                           title.hjust=0)) +
  no_background_theme +
  coord_flip()


# D
count_table <- table(sce_integrated$manual_labels_coarse, sce_integrated$Sample)
lib_sizes <- colSums(count_table)

sample_protocol_mapping <- as.data.frame(colData(sce_integrated)) %>%
  select(Protocol, Sample) %>%
  unique() %>%
  tibble::remove_rownames() %>%
  tibble::column_to_rownames('Sample')

Fig6d <- purrr::map(unique(sce_integrated$manual_labels_coarse), ~ {
  tibble::tibble(counts = count_table[.x,],
                 abundances = counts/lib_sizes,
                 Protocol= sample_protocol_mapping[levels(sce_integrated$Sample), "Protocol"],
                 Cluster = .x)}) %>% 
  purrr::reduce(rbind) %>% 
  dplyr::arrange("Cluster") %>%
  ggplot() + 
  # geom_boxplot(aes(y=abundances,x=Protocol, color=Protocol)) +
  geom_jitter(aes(y=abundances,x=Protocol, color=Protocol), size = 2, width=0.2) +
  theme_ipsum_updated +
  theme(axis.text.x = element_text(angle=45, hjust = 1), strip.text.x = element_text(family = "Helvetica",face = "bold"),
        legend.position="none") +
  scale_y_continuous(labels = scales::percent) +
  labs(#title="Relative cell type abundance by sample", 
    x="", y="") +
  facet_wrap(~Cluster, scales = "free_y",ncol = 5, nrow = 2) +
  get_protocol_colours(levels(sce_integrated$Protocol))

Fig6a
Fig6b
Fig6c
Fig6d
```

## Output

```{r figure6 one figure, fig.width=20, fig.height=26}
figure6 <- ggarrange(
  Fig6a,
  Fig6b,
  Fig6c,
  Fig6d,
  ncol = 1,labels = c("AUTO"), font.label = list(size = 30), heights=c(1.5,1.5,0.5,1.5)
)

# suppressWarnings(figure6)

scale <- 0.9
ggsave(paste0(folder_path, "figure6.jpg"),
       plot=figure6,
       width=20*scale,
       height=26*scale,
       units="in",
       bg="white")


# figure6 <- ggarrange(
#   ggarrange(ggarrange(Fig6a, Fig6b, labels = c("A", "B"), font.label = list(size = 30), nrow=2), 
#             Fig6c, labels = c("", "C"), font.label = list(size = 30), ncol=2, widths=c(3, 1)),
#   Fig6d,
#   ncol = 1,labels = c("", "D"), font.label = list(size = 30), heights=c(2,1.2) 
# )
# 
# suppressWarnings(figure6)
# 
# scale <- 0.9
# ggsave(paste0(folder_path, "figure6.jpg"),
#        plot=figure6,
#        width=20*scale,
#        height=26*scale,
#        units="in",
#        bg="white")
```

# Suppl. Figure 2 (version 1)

```{r suppl. figure 2}
subclustering_labels <- read.xlsx("../metadata/marker_genes_heatmaps.xlsx", sheet="Fresh only - subclusters")

# sort subclustering_labels alphabetically by the names
heatmap_marker_genes_subclusters <- subclustering_labels %>% 
  mutate(Gene=factor(Gene, levels=unique(Gene))) # %>%
  # arrange(Label)

plot_heatmap <- function(cell_type, normalise=TRUE){
  
  sce_subset <- sce_fresh[,sce_fresh$manual_labels_coarse2 == cell_type]
  
  # the genes which we want to display
  genes <- heatmap_marker_genes_subclusters %>%
    filter(Cell.type==cell_type) %>%
    pull(Gene)
  
  # check whether genes are in rownames
  genes_not_found <- genes[genes %in% rownames(sce_subset) == FALSE]
  if (length(genes_not_found) > 0) cat(paste0("\nGenes not found for cell type ", cell_type, ": ", genes_not_found))
  
  genes <- genes[genes %in% rownames(sce_subset)] 
  
  # the cells which we want to display, ordered by subcluster
  column_annotations <- data.frame(row.names=colnames(sce_subset),# "Sample"=sce_subset$Sample,
                                   "Subcluster"=sce_subset$subcluster_names) %>%
    arrange(Subcluster)
  
  # the logcounts which we need for the pheatmap function
  sce_plot <- logcounts(sce_subset[as.vector(genes), rownames(column_annotations)])
  # normalise by row
  sce_plot <- normalise_by_row(sce_plot)
  
  # Use own colours for the column annotations
  colours <- get_unnamed_colours(unique(column_annotations$Subcluster), type="raw")
  # colours_sample <- get_sample_colours(unique(column_annotations$Sample), type="raw")
  annotation_colours <- list(#"Sample"=colours_sample, 
                             "Subcluster"=colours)

  #plt <- grid.grabExpr(draw(hmap, annotation_legend_side="bottom", heatmap_legend_side="right")) +
  plt <- as.ggplot(pheatmap::pheatmap(as.matrix(sce_plot), cluster_cols=FALSE, cluster_rows = FALSE, 
                  show_rownames=TRUE, show_colnames=FALSE, color=viridis(50), 
                  annotation_col=column_annotations, annotation_colors=annotation_colours)) +
    theme_ipsum_updated + 
    theme(axis.line=element_blank(),axis.text.x=element_blank(),
            axis.text.y=element_blank(),axis.ticks=element_blank(),
            axis.title.x=element_blank(),
            axis.title.y=element_blank(),legend.position="none",
            panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
            panel.grid.minor=element_blank(),plot.background=element_blank()) +
    labs(title=cell_type)
  
  plt
}


sfig2a <- plot_heatmap("Fibroblasts")
sfig2b <- plot_heatmap("Keratinocytes")
sfig2c <- plot_heatmap("Pericytes/VSMC")
```


## Output

```{r suppl. figure2 one figure, fig.width=20, fig.height=26}

SFig2 <- suppressMessages(suppressWarnings(ggpubr::ggarrange(
  sfig2a, 
  sfig2b,
  sfig2c,
  ncol = 1,labels = c("AUTO"), font.label = list(size = 30)
)))

suppressMessages(suppressWarnings(SFig2))

scale <- 0.8
ggsave(paste0(folder_path, "Suppl_Figure2.jpg"),
       plot=SFig2,
       width=20*scale,
       height=26*scale,
       units="in",
       bg="white")
```


# Suppl. Figure 2 (version 2)

```{r suppl. figure 3, fig.width=14, fig.height=16}
subclustering_labels <- read.xlsx("../metadata/marker_genes_heatmaps.xlsx", sheet="Fresh only - subclusters")

relevant_cell_types <- c("Fibroblasts", "Keratinocytes", "Pericytes/VSMC") 

sce_fresh_heatmap <- sce_fresh

# Get the list into the right order
heatmap_marker_genes_subclusters <- lapply(relevant_cell_types, function(cell_type){
  subclustering_labels %>% 
    filter(Cell.type == cell_type) %>%
    arrange(Label)
}) %>% purrr::reduce(rbind)

# the genes which we want to display
genes <- heatmap_marker_genes_subclusters %>%
  pull(Gene)
# check whether genes are in rownames
genes_not_found <- genes[genes %in% rownames(sce_fresh_heatmap) == FALSE]
if (length(genes_not_found) > 0) cat(paste0("\nGenes not found: ", genes_not_found))

genes <- genes[genes %in% rownames(sce_fresh_heatmap)] 

idx <- seq(1, dim(sce_fresh_heatmap)[2], 10)
sce_fresh_heatmap <- sce_fresh_heatmap[, idx] 

# the cells which we want to display, ordered by subcluster
column_annotations <- data.frame(row.names=colnames(sce_fresh_heatmap), 
                                 "Subcluster"=sce_fresh_heatmap$subcluster_names,
                                 "Cell"=sce_fresh_heatmap$manual_labels_coarse) %>%
  mutate(Cell = case_when(Cell %in% relevant_cell_types == FALSE ~ "Other", 
                          TRUE ~ as.character(Cell))) %>%
  mutate(Subcluster = case_when(Cell== "Other" ~ "Other", 
                          TRUE ~ as.character(Subcluster))) %>%
  arrange(factor(Cell, levels = c(relevant_cell_types,"Other")), Subcluster) %>%
  mutate(Cell=factor(Cell, levels = c(relevant_cell_types,"Other")),
         Subcluster=factor(Subcluster, levels=unique(Subcluster)))

# the logcounts which we need for the pheatmap function
sce_plot <- logcounts(sce_fresh_heatmap[genes, rownames(column_annotations)])
# normalise by row
sce_plot <- normalise_by_row(sce_plot)

# Use own colours for the column annotations
# colours <- get_unnamed_colours(unique(column_annotations$Subcluster), type="raw")
# annotation_colours <- list("Subcluster"=colours)

#plt <- grid.grabExpr(draw(hmap, annotation_legend_side="bottom", heatmap_legend_side="right")) +
SFig3_v2 <- as.ggplot(pheatmap::pheatmap(as.matrix(sce_plot), cluster_cols=FALSE, cluster_rows = FALSE, 
                show_rownames=TRUE, show_colnames=FALSE, color=viridis(50), 
                annotation_col=column_annotations #, annotation_colors=annotation_colours
                )) +
  theme_ipsum_updated + 
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank())


suppressMessages(suppressWarnings(SFig3_v2))

ggsave(paste0(folder_path, "Suppl_Figure3_v2.jpg"),
       plot=SFig3_v2,
       width=18*scale,
       height=18*scale,
       units="in",
       bg="white")
```



# Suppl. Figure 3

## Panel A

```{r figure 3}
# Expression values vs genes
cat("\n\n### Expression values vs. number of genes \n\n")
figA1 <- colData(sce_fvc_unfiltered) %>% 
  as.data.frame() %>%
  ggplot(aes(x=log_total, y=subsets_genes_detected, color=to_be_dropped)) +
  geom_point(size=0.25) +
  labs(y="",
       x="Library size (log10)",
       #title="Library size vs. number of non-mitochondrial genes",
       #subtitle="Cells dropped coloured in red"
       ) +
  scale_y_log10() +
  geom_density_2d() +
  facet_wrap(~Sample, nrow=4) +
  theme_ipsum_updated +
  theme(panel.spacing = unit(2, "mm"),
        # axis.text.x = element_text(size=8),
        # axis.text.y = element_text(size=8),
        strip.text.x = element_text(size = 10),
        plot.margin = margin(t = 2, r = 20, l = 50, b = 2)) +
  guides(color=guide_legend(title="Dropped")) +
  scale_colour_manual(values=c("#2065AE", "#DB1E0D"))

figA2 <- ggplot(colData(sce_fvc_unfiltered) %>% as.data.frame,
       aes(x=log_total, y=subsets_genes_detected, color=subsets_Mt_percent)) +
  geom_point(size=0.25) +
  labs(#title="Library size vs. number of non-mitochondrial genes",
       #subtitle="Colour indicates mito. percentage of library size",
       x="Library size (log10)",
       y="") +
  scale_y_log10() +
  geom_density_2d() + 
  facet_wrap(~Sample, nrow=4) +
  theme_ipsum_updated +
  theme(panel.spacing = unit(2, "mm"),
        #axis.text.x = element_text(size=8),
        #axis.text.y = element_text(size=8),
        strip.text.x = element_text(size = 10),
        plot.margin = margin(t = 2, r = 20, l = 20, b = 2)) +# Left margin) +
  guides(color=guide_colourbar(title="% mito.")) 

suppressWarnings(figA1)
suppressWarnings(figA2)
```


## Panel B

```{r}
sample_to_protocol <- colData(sce_fvc) %>%
  as.data.frame() %>%
  dplyr::group_by(Protocol, Sample) %>%
  dplyr::summarise()

cc_sample <- sce_fvc %>% 
  nest(data=-Sample) %>% 
  mutate(n_cells = purrr::map_dbl(data, ~ dim(.x)[2]),
         sum_of_genes = purrr::map_dbl(data, ~ sum(colData(.x)$detected)),
         average_n_genes = purrr::map_dbl(data, ~ mean(colData(.x)$detected)),
         mean_n_nonzero_genes = purrr::map_dbl(data, ~ mean(rowSums(counts(.x) > 0) > 0)),
         mean_n_10cells_genes = purrr::map_dbl(data, ~ mean(rowSums(counts(.x) > 0) > 10)),
         mean_n_1perc_cells_genes = purrr::map_dbl(data, ~ mean(rowSums(counts(.x) > 0) > ceiling(dim(.x)[2]/100)))) %>%
  left_join(sample_to_protocol, by="Sample") %>%
  mutate(Protocol=factor(Protocol, levels=c("Fresh", "Culture")))


figB <- ggpubr::ggarrange(
  ggplot(cc_sample, aes(x = Sample, y = n_cells, fill = average_n_genes)) +  # Plot with values on top
    geom_bar(stat = "identity") +
    geom_text(aes(label = n_cells), vjust = 0, size = 3) +
    facet_grid(. ~ Protocol, scales="free_x", space="free_x") +
    labs(title = "", x="", fill="Mean genes\nper cell", y="Cells") +
    theme_ipsum_updated +
    theme(#axis.text.x = element_text(angle = 45, hjust=1, size=8), 
          #axis.text.y = element_text(size=8),
          axis.ticks.x = element_blank(),
          strip.text.x = element_blank(),
          panel.spacing = unit(2, "mm"),
          plot.margin = margin(5,2,2,50)) +
    ylim(c(0,6000)),
  
  ggplot(cc_sample, aes(x = Sample, y = n_cells, fill = mean_n_1perc_cells_genes)) +  # Plot with values on top
    geom_bar(stat = "identity") +
    geom_text(aes(label = n_cells), vjust = 0, size = 3) +
    facet_grid(. ~ Protocol, scales="free_x", space="free_x") +
    labs(title = "", x="", 
         fill="Num. genes\nin at least \n1% of cells",  y="Cells") +
    theme_ipsum_updated +
    theme(#axis.text.x = element_text(angle = 45,hjust=1, size=8), 
          #axis.text.y = element_text(size=8),
          axis.ticks.x=element_blank(),
          strip.text.x = element_blank(),
          panel.spacing = unit(2, "mm"),
          plot.margin = margin(5,2,2,50)) +
    ylim(c(0,6000)),
  nrow = 2)
print(figB)
```

## Panel C

```{r log10 counts by protocol}
# Log-total count density by protocol
figC1 <- sce_fvc %>% 
  ggplot() +
  theme_ipsum_updated +
  labs(#title="Distribution of cell library sizes",
       x="Log total expression", y="Density") +
  geom_density(aes(log10(total), fill=Protocol, color=Protocol), alpha=0.3) +
  get_protocol_colours(levels(colData(sce_fvc)$Protocol), type="fill", sort=F) +
  get_protocol_colours(levels(colData(sce_fvc)$Protocol), sort=F) +
  theme(plot.margin=margin(30,20,30,50))
figC1

# Log-total counts density by sample and grouped by protocol
figC2 <- sce_fvc %>% 
  ggplot() +
  geom_density(aes(log10(total), fill=Sample, color=Sample),alpha=0.1) +
  facet_grid(Protocol~.) +
  theme_ipsum_updated +
  theme(strip.text.y = element_text(size = 12),
        legend.key.size= unit(5, "mm")) +
  guides(fill=guide_legend(ncol=1, )) +
  labs(#title="Distribution of cell library sizes",
       x="Log total expression", y="Density") +
  theme(panel.spacing = unit(2, "mm"),
        plot.margin = margin(30,20,30,30)) +
  get_sample_colours(levels(colData(sce_fvc)$Sample), type="fill", sort=F) +
  get_sample_colours(levels(colData(sce_fvc)$Sample), sort=F)
figC2
```

## Panel D

```{r panel D, fig.width=14, fig.height=10}
# Log-number of genes density by protocol
figD1 <- sce_fvc %>% 
  ggplot() +
  geom_density(aes(log10(detected), fill=Protocol, color=Protocol), alpha=0.3) +
  theme_ipsum_updated +
  labs(#title="Distribution of gene counts",
       x="Number of genes (log10)", y="Density") +
  get_protocol_colours(levels(colData(sce_fvc)$Protocol), sort=F) +
  get_protocol_colours(levels(colData(sce_fvc)$Protocol), type="fill", sort=F) +
  theme(plot.margin=margin(30,20,30,50))

# Log-number of genes density by sample and grouped by protocol
figD2 <- sce_fvc %>% 
  ggplot() +
  geom_density(aes(log10(detected), fill=Sample, color=Sample),alpha=0.1) +
  facet_grid(Protocol~.) +
  theme_ipsum_updated +
  theme(strip.text.y = element_text(size = 12),
        legend.key.size= unit(5, "mm"),
        plot.margin = margin(30,20,30,30)) +
  guides(fill=guide_legend(ncol=1)) +
  labs(#title="Distribution of gene counts",
       x="Number of genes (log10)", y="Density") +
  get_sample_colours(levels(colData(sce_fvc)$Sample), type="fill", sort=F) +
  get_sample_colours(levels(colData(sce_fvc)$Sample), sort=F)

figD1
figD2
```

## Output

```{r supplementary figure 3, fig.width=20, fig.height=26}
Suppl_Figure3 <- ggpubr::ggarrange(
  ggpubr::ggarrange(figA1,figA2, ncol = 2),
  figB,
  ggpubr::ggarrange(figC1, figC2, ncol=2),
  ggpubr::ggarrange(figD1, figD2, ncol=2),
  ncol = 1, nrow = 4,labels = "AUTO", font.label = list(size = 30)
)

suppressWarnings(Suppl_Figure3)

ggsave(paste0(folder_path, "Suppl_Figure3.jpg"),
       plot=Suppl_Figure3,
       width=20*0.9,
       height=26*0.9,
       units="in",
       bg="white")
```



# Suppl. Figure 4

* Barchart of cells dropped in Fresh and culture
* Barchart of cells dropped and kept in integrated analysis
* Jitter plot of fresh v culture

```{r Suppl. figure 4}
# A
plt_dataA <- colData(sce_edi_unfiltered) %>%
  as.data.frame() %>%
  group_by(Protocol, Sample, to_be_dropped) %>%
  summarise(counts=n())

sfig4a <- ggplot(plt_dataA) +
  geom_bar(aes(x=Sample, y=counts, fill=to_be_dropped), stat="identity") +
  get_boolean_colour_scale(type="fill", reverse=T) +
  theme_ipsum_updated +
  facet_grid(.~Protocol, scales="free_x", space="free") +
  guides(fill=guide_legend(title="Cells dropped")) +
  labs(#title="Cells dropped by quality control",
       #subtitle="Integrated data",
       x="", y="Cells") +
  theme(axis.text.x=element_text(angle=45, hjust=1))

# B
sce_fvc_unfiltered$to_be_dropped <- factor(sce_fvc_unfiltered$to_be_dropped, levels=c(TRUE, FALSE))

plt_dataB <- colData(sce_fvc_unfiltered) %>%
  as.data.frame() %>%
  group_by(Protocol, Sample, to_be_dropped) %>%
  summarise(counts=n())

sfig4b <- ggplot(plt_dataB) +
  geom_bar(aes(x=Sample, y=counts, fill=to_be_dropped), stat="identity") +
  get_boolean_colour_scale(type="fill", reverse=T) +
  theme_ipsum_updated +
  facet_grid(.~Protocol, scales="free_x", space="free") +
  guides(fill=guide_legend(title="Cells dropped")) +
  labs(#title="Cells dropped by quality control",
       #subtitle="Fresh and cultured samples",
       x="", y="Cells")


# C
count_table <- table(sce_fvc$manual_labels_coarse, sce_fvc$Sample)
lib_sizes <- colSums(count_table)

sample_protocol_mapping <- as.data.frame(colData(sce_fvc)) %>%
  select(Protocol, Sample) %>%
  unique() %>%
  tibble::remove_rownames() %>%
  tibble::column_to_rownames('Sample')

sfig4c <- purrr::map(unique(sce_fvc$manual_labels_coarse), ~ {
  tibble::tibble(counts = count_table[.x,],
                 abundances = counts/lib_sizes,
                 Protocol= sample_protocol_mapping[levels(sce_fvc$Sample), "Protocol"],
                 Cluster = .x)}) %>% 
  purrr::reduce(rbind) %>% 
  dplyr::arrange("Cluster") %>%
  ggplot() + 
  # geom_boxplot(aes(y=abundances,x=Protocol, color=Protocol)) +
  geom_jitter(aes(y=abundances,x=Protocol, color=Protocol), size = 2, width=0.2) +
  theme_ipsum_updated +
  theme(# axis.text.x = element_text(angle=45, hjust = 1),
    strip.text.x = element_text(family = "Helvetica",face = "bold"),
    legend.position="none", panel.spacing=unit(10,"mm")) +
  scale_y_continuous(labels = scales::percent) +
  labs(#title="Relative cell type abundance", 
       #subtitle="Fresh and cultured samples", 
    x="", y="") +
  facet_wrap(~Cluster, scales = "free_y",ncol = 6, nrow = 2) +
  get_protocol_colours(levels(sce_fvc$Protocol))
  
```

## Output

```{r suppl. figure4 one figure, fig.width=15, fig.height=19.5}

SFig4 <- suppressMessages(suppressWarnings(ggarrange(
  sfig4b, sfig4c, sfig4a,
  ncol = 1, labels = c("AUTO"), font.label = list(size = 20), heights=c(1,1,1.5)
)))

suppressMessages(suppressWarnings(SFig4))

scale <- 0.8
ggsave(paste0(folder_path, "Suppl_Figure4.jpg"),
       plot=SFig4,
       width=20*scale,
       height=26*scale,
       units="in",
       bg="white")
```

# Suppl. Table 1

```{r}

# colnames(colData(sce_edi_unfiltered))
integrated_data_mean <- colData(sce_integrated) %>%
  as.data.frame() %>%
  dplyr::group_by(Sample) %>%
  summarise_at(vars(sum, detected), mean) %>%
  rename(Library_Size_mean=sum, Num_Genes_mean=detected)

data_integrated <- colData(sce_integrated) %>%
  as.data.frame() %>%
  dplyr::group_by(Sample) %>%
  summarise_at(vars(sum, detected), median) %>%
  rename(Library_Size_median=sum, Num_Genes_median=detected) %>%
  left_join(integrated_data_mean)


# Save as image
kable(data_integrated, digits=0) %>%
  kable_styling() %>%
  save_kable(file = paste0(folder_path, "Suppl_table_1.jpg"))

# Write as csv
write.csv(data_integrated, paste0(folder_path, "Suppl_table_1.csv"))


# Table 2

# colnames(colData(sce_edi_unfiltered))
fvc_data_mean <- colData(sce_fvc) %>%
  as.data.frame() %>%
  dplyr::group_by(Sample) %>%
  summarise_at(vars(sum, detected), mean) %>%
  rename(Library_Size_mean=sum, Num_Genes_mean=detected)
 
data_fvc <- colData(sce_fvc) %>%
  as.data.frame() %>%
  dplyr::group_by(Sample) %>%
  summarise_at(vars(sum, detected), median) %>%
  rename(Library_Size_median=sum, Num_Genes_median=detected) %>%
  left_join(fvc_data_mean)

# Save as image
kable(data_fvc, digits=0) %>%
  kable_styling() %>%
  save_kable(file = paste0(folder_path, "Suppl_table_2.jpg"))

# Write as csv
write.csv(data_fvc, paste0(folder_path, "Suppl_table_2.csv"))


# By procol for integrated data. These numbers are just referenced in the text
# colnames(colData(sce_edi_unfiltered))
integrated_data_mean_protocol <- colData(sce_integrated) %>%
  as.data.frame() %>%
  dplyr::group_by(Protocol) %>%
  summarise_at(vars(sum, detected), mean) %>%
  rename(Library_Size_mean=sum, Num_Genes_mean=detected)

data_integrated_protocol <- colData(sce_integrated) %>%
  as.data.frame() %>%
  dplyr::group_by(Protocol) %>%
  summarise_at(vars(sum, detected), median) %>%
  rename(Library_Size_median=sum, Num_Genes_median=detected) %>%
  left_join(integrated_data_mean_protocol)

```

# Review

```{r review folder}
review_folder <- "../output/review_figures/"
```


## (1)

Are some expression profiles associated with samples in certain cell types?

Pursuant to review comment we check whether the overexpression of the following genes are associated with certain samples:

* COL1A1 and COL6A1 (Fibroblasts)
* TAGLN, ACTA2, and COL1A1 (Pericytes)
* TAGLN (Vascular endothelial)

This is relevant for the data from the fresh protocol only

We will look at:

* Expression values as a violin plot after subsetting for the given cell type. Samples on the x-axis

```{r}
cell_type_genes <- list("Fibroblasts"=c("COL1A1", "COL6A1"),
                  "Pericytes/VSMC"=c("TAGLN", "ACTA2", "COL1A1"),
                  "Vascular endothelial"=c("TAGLN")) #, "PECAM1", "VWF", "CLDN5"

vio_plots <- lapply(names(cell_type_genes), function(ct){
  sce <- sce_fresh[,sce_fresh$manual_labels_coarse == ct]

  plotExpression(sce, features=cell_type_genes[[ct]], x = "Sample", colour_by = "Sample", ncol=3) +
    theme_ipsum_updated +
    get_sample_colours(levels(sce$Sample)) +
    theme(legend.position="none") +
    labs(title=paste0("Selected genes for ", ct),
         x="")
})

```

```{r supplementary figure 3, fig.width=20, fig.height=26}
Review1 <- ggpubr::ggarrange(
  vio_plots[[1]],
  vio_plots[[2]],
  vio_plots[[3]],
  ncol = 1, nrow = 3,labels = "AUTO", font.label = list(size = 30)
)

suppressWarnings(Review1)

ggsave(paste0(review_folder, "Review1.jpg"),
       plot=Review1,
       width=10*0.9,
       height=13*0.9,
       units="in",
       bg="white")
```


```{r, fig.width=14, fig.height=10}

#########
### B ###
#########

genes <- c("DCN", "COL1A1", "COL6A1", "TAGLN", "ACTA2", "RGS5", "PECAM1", 
           "VWF", "CLDN5", "FABP4", "LYVE1", "CCL21", "KRT5", "KRT10", "KRT15", 
           "IL7R", "CD3D", "CXCR4", "LYZ", "HLA-DRA", "CXCL8", "TPSB2", "TPSAB1", 
           "CTSG", "PMEL", "DCT", "MLANA", "CDH19", "CRYAB", "ITGB8")

cell_type_order <- c("Fibroblasts", "Pericytes/VSMC",	"Vascular endothelial",	"Lymphatic endothelial", "Keratinocytes",	"T cells",	"Macrophages/DC",	"Mast cells", "Melanocytes", "Schwann cells")

sce_fresh_plot <- sce_fresh[,selected_cells]
# sort(sce_fresh_plot$manual_labels_coarse, sce_fresh_plot$Sample)

# the cells which we want to display, ordered by cell type
column_annotations <- data.frame(cell_name=rownames(colData(sce_fresh_plot)), 
                                 Sample=colData(sce_fresh_plot)[,"Sample"],
                                Cell_type=factor(colData(sce_fresh_plot)[,"manual_labels_coarse"], levels=cell_type_order)) %>%
    filter(Cell_type!="NA") %>%
    arrange(Cell_type) %>%
    tibble::column_to_rownames(var="cell_name")

# the logcounts which we need for the pheatmap function
sce_plot <- logcounts(sce_fresh_plot[genes, rownames(column_annotations)])
sce_plot <- normalise_by_row(sce_plot)

# Use own colours for the column annotations
colours <- get_cell_colours(cell_type_order, type="raw", sort=F)
colours_sample <- get_sample_colours(levels(sce_fresh$Sample), type="raw")
annotation_colours <- list("Sample"=colours_sample, "Cell_type"=colours)


# create the plot. We convert to ggplot to take advantage of some of the display functions
Fig2b_review <- as.ggplot(pheatmap(sce_plot, annotation_col=column_annotations, annotation_colors=annotation_colours,
         show_rownames=TRUE, show_colnames=FALSE, cluster_cols=FALSE, cluster_rows = FALSE, silent=TRUE,
         color=viridis(50))) +
  theme_ipsum_updated +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(), 
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank())
Fig2b_review

ggsave(paste0(review_folder, "Fig2b_review.jpg"),
       plot=Fig2b_review,
       width=12*0.9,
       height=10*0.9,
       units="in",
       bg="white")
```


## (2) Technical variability

```{r, fig.width=14, fig.height=8}
plotReducedDim(sce_fvc, "UMAP", colour_by="Sample", point_size=0.25) +
  # labs(title="UMAP coloured by protocol",
  #      subtitle = "Fresh and cultured samples") +
  theme_ipsum_updated +
  get_sample_colours(levels(sce_fvc$Sample)) +
  theme(legend.position="right",
        panel.spacing = unit(5, "mm"),
        plot.margin=margin(t=5, l=50, r=100, b=5)) +
  guides(color=guide_legend(title="",
                            # nrow=1,
                            byrow=TRUE, 
                            override.aes = list(size=4, shape = 15, alpha = 1)))
```




## Table of cell type abundances in figure 6

```{r}
dmm <- purrr::map(unique(sce_integrated$manual_labels_coarse), ~ {
  tibble::tibble(counts = count_table[.x,],
                 abundances = counts/lib_sizes,
                 Protocol= sample_protocol_mapping[levels(sce_integrated$Sample), "Protocol"],
                 Cluster = .x)}) %>% 
  purrr::reduce(rbind) %>% 
  dplyr::arrange("Cluster")

write.csv(dmm,file="../output/ct_abundance.csv", sep=";")
write.xlsx(dmm, file="../output/ct_abundance.xlsx")

table(sce_integrated$Sample)
table(sce_integrated$Protocol)
```



## Median gene count vs median lib size per sample


```{r sample gene vs lib size, fig.width=10, fig.height=7}

review4 <- colData(sce_integrated) %>%
  as.data.frame() %>%
  group_by(Sample)  %>%
  select(c(Sample, Protocol, sum, detected)) %>%
  summarise_at(vars(sum, detected), median) %>%
  ggplot() +
  geom_point(aes(sum, detected, colour=Sample)) +
  theme_ipsum_updated +
  get_sample_colours(levels(sce_integrated$Sample)) +
  guides(colour=guide_legend(ncol=1,override.aes = list(size=5, shape=15))) +
  labs(title="Median gene count vs median library size per sample",
       y="Median genes detected",
       x="Median lib. size")

ggsave(paste0(review_folder, "Review4.jpg"),
       plot=review4,
       width=12*0.9,
       height=10*0.9,
       units="in",
       bg="white")
ggsave(paste0(review_folder, "Fig2b_review.jpg"),
       plot=Fig2b_review,
       width=12*0.9,
       height=10*0.9,
       units="in",
       bg="white")

```
















